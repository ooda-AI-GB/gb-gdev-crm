{% extends "layout/base.html" %}

{% block content %}
<div class="top-bar">
    <h1>Pipeline</h1>
    <div style="display: flex; gap: 0.5rem;">
        <a href="/pipeline/export" class="btn btn-outline">Export Deals</a>
        <button onclick="document.getElementById('dealModal').showModal()" class="btn btn-primary">+ New Deal</button>
    </div>
</div>

<form method="GET" action="/pipeline" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
    <input type="text" name="q" value="{{ q or '' }}" placeholder="Search deals or contacts..." style="max-width: 300px;">
    <button type="submit" class="btn btn-primary">Search</button>
    {% if q %}
    <a href="/pipeline" class="btn btn-outline" style="text-decoration: none; padding: 0.5rem 1rem;">Clear</a>
    {% endif %}
</form>

    <style>
        .deal-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
            cursor: grab;
        }
        .deal-card:active {
            cursor: grabbing;
        }
        .deal-card.dragging {
            opacity: 0.6;
            transform: scale(1.02) rotate(1deg);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
            z-index: 100;
        }
        .pipeline-column {
            transition: border-color 0.2s ease, background-color 0.2s ease;
            border: 2px solid transparent;
            height: 100%;
        }
        .pipeline-column.drag-over {
            border-color: var(--primary);
            background-color: rgba(79, 142, 247, 0.05);
        }
        .column-stats {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
    </style>
    <div class="pipeline-board">
    {% for stage in stages %}
    <div class="pipeline-column" id="col-{{ stage }}" data-stage="{{ stage }}" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
        <div class="column-header">
            <span>{{ stage.replace('_', ' ')|capitalize }}</span>
            <div class="column-stats">
                <span class="count-badge" id="count-{{ stage }}">{{ deals_by_stage[stage]|length }}</span>
                {% set stage_val = deals_by_stage[stage]|map(attribute='value')|sum %}
                <span class="count-badge" id="val-{{ stage }}" data-value="{{ stage_val }}" style="background-color: transparent; color: var(--text-secondary); border: 1px solid var(--border);">${{ "{:,.0f}".format(stage_val) }}</span>
            </div>
        </div>
        
        {% for deal in deals_by_stage[stage] %}
        <div class="deal-card" id="deal-{{ deal.id }}" data-value="{{ deal.value }}" draggable="true" ondragstart="drag(event, '{{ deal.id }}')" ondragend="dragEnd(event)">
            <div style="font-weight: 600;">{{ deal.title }}</div>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">{{ deal.contact.name }}</div>
            <div class="deal-value">${{ "{:,.0f}".format(deal.value) }}</div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-secondary);">
                <span>{{ deal.probability }}% prob.</span>
                <span>{{ deal.expected_close.strftime('%b %d') if deal.expected_close else '-' }}</span>
            </div>
            
            <div class="probability-bar">
                <div class="probability-fill" style="width: {{ deal.probability }}%; background-color: {% if deal.probability > 70 %}var(--success){% elif deal.probability > 40 %}var(--warning){% else %}var(--danger){% endif %};"></div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>

<!-- New Deal Modal -->
<dialog id="dealModal" style="border: none; border-radius: 8px; padding: 0; max-width: 500px; width: 100%;">
    <div style="padding: 1.5rem;">
        <h3 style="margin-top: 0;">New Deal</h3>
        <form action="/pipeline/deals" method="post">
            <div class="form-group">
                <label>Title</label>
                <input type="text" name="title" required>
            </div>
            <div class="form-group">
                <label>Contact ID</label>
                <!-- In a real app this would be a search/dropdown. For now just ID or maybe fetch contacts? -->
                <!-- Let's assume we can enter ID or we should have passed contacts to this template. -->
                <!-- I forgot to pass contacts to this template. I will update pipeline.py later if needed. -->
                <!-- But for now, let's just use input number as a fallback. -->
                <input type="number" name="contact_id" required placeholder="Enter Contact ID">
            </div>
            <div class="form-group">
                <label>Value ($)</label>
                <input type="number" step="0.01" name="value" required>
            </div>
            <div class="form-group">
                <label>Stage</label>
                <select name="stage">
                    {% for s in stages %}
                    <option value="{{ s }}">{{ s.replace('_', ' ')|capitalize }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Probability (%)</label>
                <input type="number" min="0" max="100" name="probability" value="50">
            </div>
            <div class="form-group">
                <label>Expected Close</label>
                <input type="date" name="expected_close">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                <button type="button" onclick="document.getElementById('dealModal').close()" class="btn btn-outline">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</dialog>

<script>
    let draggedItem = null;

    function allowDrop(ev) {
        ev.preventDefault();
        ev.dataTransfer.dropEffect = "move";
    }

    function dragEnter(ev) {
        ev.preventDefault();
        const column = ev.target.closest('.pipeline-column');
        if (column) {
            column.classList.add('drag-over');
        }
    }

    function dragLeave(ev) {
        // Only remove if leaving the column entirely, not entering a child
        const column = ev.target.closest('.pipeline-column');
        if (column && !column.contains(ev.relatedTarget)) {
            column.classList.remove('drag-over');
        }
    }

    function drag(ev, id) {
        // Ensure we get the card element, not a child
        let card = ev.target.closest('.deal-card');
        if (!card) return;
        
        draggedItem = card;
        ev.dataTransfer.setData("text", id);
        ev.dataTransfer.effectAllowed = "move";
        // Delay adding class so the drag image is taken from original state
        setTimeout(() => card.classList.add('dragging'), 0);
    }

    function dragEnd(ev) {
        if (draggedItem) {
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        }
        // Ensure all columns lose drag-over state
        document.querySelectorAll('.pipeline-column').forEach(col => col.classList.remove('drag-over'));
    }

    function drop(ev) {
        ev.preventDefault();
        
        // Find drop target column
        const column = ev.target.closest('.pipeline-column');
        if (!column) return;
        
        // Remove highlight
        column.classList.remove('drag-over');
        
        const stage = column.getAttribute('data-stage');
        var id = ev.dataTransfer.getData("text");
        
        // Find the card element.
        let card = draggedItem;
        if (!card) {
            card = document.getElementById('deal-' + id);
        }
        if (!card) return;

        const oldColumn = card.closest('.pipeline-column');
        const oldStage = oldColumn.getAttribute('data-stage');

        // If dropped in same column, do nothing
        if (oldStage === stage) return;

        // Optimistic UI Update: Move card
        column.appendChild(card);
        
        // Update Stats
        updateStats(oldStage, stage, parseFloat(card.getAttribute('data-value')));

        // Send POST request
        const formData = new FormData();
        formData.append('stage', stage);
        
        fetch(`/pipeline/deals/${id}/move`, {
            method: 'POST',
            body: formData
        }).then(response => {
            if (!response.ok) {
                // Revert on failure
                alert('Failed to move deal');
                oldColumn.appendChild(card);
                updateStats(stage, oldStage, parseFloat(card.getAttribute('data-value'))); // Revert stats
            }
        });
    }

    function updateStats(fromStage, toStage, value) {
        // Update counts
        const fromCountEl = document.getElementById(`count-${fromStage}`);
        const toCountEl = document.getElementById(`count-${toStage}`);
        
        if (fromCountEl) fromCountEl.innerText = parseInt(fromCountEl.innerText) - 1;
        if (toCountEl) toCountEl.innerText = parseInt(toCountEl.innerText) + 1;
        
        // Update values
        const fromValEl = document.getElementById(`val-${fromStage}`);
        const toValEl = document.getElementById(`val-${toStage}`);
        
        // Helper to format number to currency: 1200 -> "$1,200"
        const formatCurrency = (num) => {
            return '$' + num.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        };

        if (fromValEl) {
            let currentVal = parseFloat(fromValEl.getAttribute('data-value')) || 0;
            let newVal = currentVal - value;
            fromValEl.setAttribute('data-value', newVal);
            fromValEl.innerText = formatCurrency(newVal);
        }
        
        if (toValEl) {
            let currentVal = parseFloat(toValEl.getAttribute('data-value')) || 0;
            let newVal = currentVal + value;
            toValEl.setAttribute('data-value', newVal);
            toValEl.innerText = formatCurrency(newVal);
        }
    }
</script>
{% endblock %}
