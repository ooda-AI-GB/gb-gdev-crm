{% extends "layout/base.html" %}

{% block content %}
<div class="top-bar">
    <h1>Contacts</h1>
    <div style="display: flex; gap: 0.5rem;">
        <button onclick="document.getElementById('importModal').showModal()" class="btn btn-outline">Import CSV</button>
        <a href="/contacts/export" class="btn btn-outline">Export All</a>
        <a href="/contacts/new" class="btn btn-primary">+ New Contact</a>
    </div>
</div>

{% if message %}
<div style="background: #dcfce7; color: #15803d; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
    {{ message }}
</div>
{% endif %}

    <style>
        .floating-action-bar {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 2rem;
            z-index: 1000;
            border: 1px solid #eee;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        .floating-action-bar .actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .count-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-weight: 500;
            font-size: 0.9rem;
        }
    </style>

    <div class="card">
        <form method="GET" action="/contacts" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <input type="text" name="q" value="{{ q or '' }}" placeholder="Search contacts..." id="searchInput">
            <select name="status" id="statusFilter" onchange="this.form.submit()">
                <option value="">All Statuses</option>
                <option value="lead" {% if status == 'lead' %}selected{% endif %}>Lead</option>
                <option value="contacted" {% if status == 'contacted' %}selected{% endif %}>Contacted</option>
                <option value="proposal" {% if status == 'proposal' %}selected{% endif %}>Proposal</option>
                <option value="negotiation" {% if status == 'negotiation' %}selected{% endif %}>Negotiation</option>
                <option value="closed_won" {% if status == 'closed_won' %}selected{% endif %}>Closed Won</option>
                <option value="closed_lost" {% if status == 'closed_lost' %}selected{% endif %}>Closed Lost</option>
            </select>
            <button type="submit" class="btn btn-primary" style="padding: 0.5rem 1rem;">Search</button>
            {% if q or status %}
                <a href="/contacts" class="btn btn-outline" style="text-decoration: none; padding: 0.5rem 1rem;">Clear</a>
            {% endif %}
        </form>
    
        <table>
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="selectAll" onclick="toggleAll(this)">
                    </th>
                    <th>
                        <a href="/contacts?sort=name&order={% if sort == 'name' and order == 'asc' %}desc{% else %}asc{% endif %}{% if q %}&q={{ q }}{% endif %}{% if status %}&status={{ status }}{% endif %}" style="color: inherit; text-decoration: none;">
                            Name {% if sort == 'name' %}{% if order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                        </a>
                    </th>
                    <th>Email</th>
                    <th>
                        <a href="/contacts?sort=company&order={% if sort == 'company' and order == 'asc' %}desc{% else %}asc{% endif %}{% if q %}&q={{ q }}{% endif %}{% if status %}&status={{ status }}{% endif %}" style="color: inherit; text-decoration: none;">
                            Company {% if sort == 'company' %}{% if order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="/contacts?sort=status&order={% if sort == 'status' and order == 'asc' %}desc{% else %}asc{% endif %}{% if q %}&q={{ q }}{% endif %}{% if status %}&status={{ status }}{% endif %}" style="color: inherit; text-decoration: none;">
                            Status {% if sort == 'status' %}{% if order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="/contacts?sort=created_at&order={% if sort == 'created_at' and order == 'asc' %}desc{% else %}asc{% endif %}{% if q %}&q={{ q }}{% endif %}{% if status %}&status={{ status }}{% endif %}" style="color: inherit; text-decoration: none;">
                            Created {% if sort == 'created_at' %}{% if order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                        </a>
                    </th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for contact in contacts %}
                <tr>
                    <td>
                        <input type="checkbox" class="contact-checkbox" value="{{ contact.id }}" onchange="updateBulkActions()">
                    </td>
                    <td><a href="/contacts/{{ contact.id }}" style="color: var(--primary); font-weight: 500; text-decoration: none;">{{ contact.name }}</a></td>
                    <td>{{ contact.email }}</td>
                    <td>{{ contact.company or '' }}</td>
                    <td><span class="badge badge-{{ contact.status }}">{{ contact.status.replace('_', ' ') }}</span></td>
                    <td>{{ contact.created_at.strftime('%Y-%m-%d') }}</td>
                    <td style="text-align: right;">
                        <a href="/contacts/{{ contact.id }}/edit" class="btn btn-sm btn-outline">Edit</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="bulkActions" class="floating-action-bar" style="display: none;">
        <span id="selectedCount" class="count-badge">0 selected</span>
        <div class="actions">
            <select id="bulkStatusSelect" onchange="bulkUpdateStatus(this.value)" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                <option value="">Change Status...</option>
                <option value="lead">Lead</option>
                <option value="contacted">Contacted</option>
                <option value="proposal">Proposal</option>
                <option value="negotiation">Negotiation</option>
                <option value="closed_won">Closed Won</option>
                <option value="closed_lost">Closed Lost</option>
            </select>
            <button onclick="bulkDelete()" class="btn btn-outline" style="color: #dc3545; border-color: #dc3545;">Delete Selected</button>
            <button onclick="bulkExport()" class="btn btn-outline">Export CSV</button>
        </div>
    </div>

    <script>
        function toggleAll(source) {
            checkboxes = document.getElementsByClassName('contact-checkbox');
            for(var i=0, n=checkboxes.length;i<n;i++) {
                checkboxes[i].checked = source.checked;
            }
            updateBulkActions();
        }

        function updateBulkActions() {
            const checkboxes = document.getElementsByClassName('contact-checkbox');
            let selectedCount = 0;
            for(let box of checkboxes) {
                if(box.checked) selectedCount++;
            }

            const actionBar = document.getElementById('bulkActions');
            const countBadge = document.getElementById('selectedCount');
            
            if(selectedCount > 0) {
                actionBar.style.display = 'flex';
                countBadge.textContent = selectedCount + ' selected';
            } else {
                actionBar.style.display = 'none';
            }
        }

        function getSelectedIds() {
            const checkboxes = document.getElementsByClassName('contact-checkbox');
            const ids = [];
            for(let box of checkboxes) {
                if(box.checked) ids.push(parseInt(box.value));
            }
            return ids;
        }

        async function bulkUpdateStatus(status) {
            if(!status) return;
            
            const ids = getSelectedIds();
            if(ids.length === 0) return;

            try {
                const response = await fetch('/contacts/bulk-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ids: ids,
                        status: status
                    })
                });

                if(response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to update status');
                }
            } catch(e) {
                console.error(e);
                alert('An error occurred');
            }
        }

        async function bulkDelete() {
            const ids = getSelectedIds();
            if(ids.length === 0) return;

            if(!confirm(`Are you sure you want to delete ${ids.length} contacts?`)) return;

            try {
                const response = await fetch('/contacts/bulk-delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ids: ids
                    })
                });

                if(response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to delete contacts');
                }
            } catch(e) {
                console.error(e);
                alert('An error occurred');
            }
        }

        function bulkExport() {
            const ids = getSelectedIds();
            if(ids.length === 0) return;
            
            window.location.href = `/contacts/export?ids=${ids.join(',')}`;
        }
    </script>

<dialog id="importModal" style="border: none; border-radius: 8px; padding: 0; max-width: 500px; width: 100%;">
    <div style="padding: 1.5rem;">
        <h3 style="margin-top: 0;">Import Contacts</h3>
        <p>Upload a CSV file to import contacts.</p>
        <form action="/contacts/import" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <input type="file" name="file" accept=".csv" required style="width: 100%; margin-bottom: 1rem;">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem;">
                <button type="button" onclick="document.getElementById('importModal').close()" class="btn btn-outline">Cancel</button>
                <button type="submit" class="btn btn-primary">Upload</button>
            </div>
        </form>
    </div>
</dialog>

{% endblock %}
