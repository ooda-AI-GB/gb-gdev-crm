{% extends "layout/base.html" %}

{% block content %}
<style>
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    @media (max-width: 900px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
        /* Make the existing grid responsive too if it isn't already */
        .existing-grid {
            grid-template-columns: 1fr !important;
        }
    }
</style>

<div class="top-bar">
    <h1>Dashboard</h1>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ total_contacts }}</div>
        <div class="stat-label">Total Contacts</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ open_deals_count }}</div>
        <div class="stat-label">Open Deals</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">${{ "{:,.0f}".format(total_pipeline_value) }}</div>
        <div class="stat-label">Pipeline Value</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ win_rate }}%</div>
        <div class="stat-label">Win Rate</div>
    </div>
</div>

<!-- Charts -->
<div class="charts-grid">
    <div class="card">
        <h3>Pipeline Value by Stage</h3>
        <div class="chart-container">
            <canvas id="pipelineValueChart"></canvas>
        </div>
    </div>
    <div class="card">
        <h3>Deal Count by Stage</h3>
        <div class="chart-container">
            <canvas id="dealCountChart"></canvas>
        </div>
    </div>
    <div class="card" style="grid-column: 1 / -1;">
        <h3>Activity Trends (Last 30 Days)</h3>
        <div class="chart-container">
            <canvas id="activityTrendChart"></canvas>
        </div>
    </div>
</div>

<div class="existing-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
    <!-- Pipeline Summary -->
    <div class="card">
        <h2>Pipeline Summary</h2>
        <table style="width: 100%; margin-top: 1rem;">
            <thead>
                <tr>
                    <th>Stage</th>
                    <th>Count</th>
                    <th style="text-align: right;">Value</th>
                </tr>
            </thead>
            <tbody>
                {% for stage, data in pipeline_summary.items() %}
                <tr>
                    <td><span class="badge badge-{{ stage }}">{{ stage.replace('_', ' ') }}</span></td>
                    <td>{{ data.count }}</td>
                    <td style="text-align: right;">${{ "{:,.0f}".format(data.value) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Upcoming Tasks -->
    <div class="card">
        <h2>Upcoming Tasks</h2>
        <div style="margin-top: 1rem;">
            {% if upcoming_tasks %}
                {% for task in upcoming_tasks %}
                <div style="border-bottom: 1px solid var(--border); padding: 0.75rem 0; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600;">{{ task.subject }}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            Due: {{ task.date.strftime('%b %d, %I:%M %p') }}
                        </div>
                    </div>
                    <form action="/activities/{{ task.id }}/complete" method="post" style="margin: 0;">
                        <button type="submit" class="btn btn-sm btn-outline">Done</button>
                    </form>
                </div>
                {% endfor %}
            {% else %}
                <div style="color: var(--text-secondary); text-align: center; padding: 1rem;">No upcoming tasks</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Recent Activities -->
<div class="card" style="margin-top: 2rem;">
    <h2>Recent Activities</h2>
    <div class="timeline" style="margin-top: 1.5rem;">
        {% for activity in recent_activities %}
        <div class="timeline-item">
            <div class="timeline-marker"></div>
            <div style="font-weight: 600;">{{ activity.type|capitalize }}: {{ activity.subject }}</div>
            <div style="font-size: 0.9rem; margin-top: 0.25rem;">{{ activity.description or '' }}</div>
            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                {{ activity.created_at.strftime('%b %d, %Y at %I:%M %p') }}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chartData = {{ chart_data | tojson }};
        
        // Pipeline Value Chart (Horizontal Bar)
        const ctxValue = document.getElementById('pipelineValueChart').getContext('2d');
        new Chart(ctxValue, {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Total Value ($)',
                    data: chartData.deal_values,
                    backgroundColor: [
                        '#dbeafe', // qualified
                        '#ffedd5', // proposal
                        '#f3e8ff', // negotiation
                        '#dcfce7', // closed won
                        '#fee2e2'  // closed lost
                    ],
                    borderColor: [
                        '#1e40af',
                        '#c2410c',
                        '#7e22ce',
                        '#15803d',
                        '#b91c1c'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });

        // Deal Count Chart (Doughnut)
        const ctxCount = document.getElementById('dealCountChart').getContext('2d');
        new Chart(ctxCount, {
            type: 'doughnut',
            data: {
                labels: chartData.labels,
                datasets: [{
                    data: chartData.deal_counts,
                    backgroundColor: [
                        '#dbeafe', '#ffedd5', '#f3e8ff', '#dcfce7', '#fee2e2'
                    ],
                    borderColor: [
                        '#1e40af', '#c2410c', '#7e22ce', '#15803d', '#b91c1c'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // Activity Trends Chart (Line)
        const ctxActivity = document.getElementById('activityTrendChart').getContext('2d');
        new Chart(ctxActivity, {
            type: 'line',
            data: {
                labels: chartData.activity_labels,
                datasets: chartData.activity_datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    });
</script>
{% endblock %}
